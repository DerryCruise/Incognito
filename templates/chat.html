<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room_name }}</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    />
    <style>
      body {
        background: #f0f2f5;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        height: 100vh;
        margin: 0;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        background: #1f2937;
        color: white;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-right: 2px solid #111827;
      }

      .sidebar h5 {
        font-weight: 600;
      }

      .contacts {
        flex: 1;
        overflow-y: auto;
      }

      .list-group-item {
        background: transparent !important;
        border: none !important;
        padding: 15px;
        transition: 0.3s;
        border-radius: 10px;
        margin-bottom: 5px;
      }

      .list-group-item:hover {
        background: #374151 !important;
        cursor: pointer;
      }

      .list-group-item.active {
        background: #2563eb !important;
        color: white !important;
        font-weight: 600;
      }

      .profile-icon {
        border: 2px solid #2563eb;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
      }

      .logout {
        padding: 15px;
        border-top: 1px solid #374151;
      }

      .logout a {
        color: #f87171;
        text-decoration: none;
        font-weight: 600;
      }

      /* Chat Area */
      .chat {
        display: flex;
        flex-direction: column;
        background: #e5e7eb;
      }

      .chat-header {
        background: white;
        padding: 15px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #d1d5db;
      }

      .chat-header h3 {
        margin: 0;
        font-weight: 600;
        color: #111827;
      }

      .chatbox {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f0f2f5;
      }

      .chat-message {
        max-width: 65%;
        padding: 10px 15px;
        margin-bottom: 12px;
        border-radius: 18px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 15px;
      }

      .chat-message.sender {
        background: #2563eb;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
      }

      .chat-message.receiver {
        background: white;
        color: #111827;
        margin-right: auto;
        border-bottom-left-radius: 4px;
      }

      /* Input */
      .chat-input {
        background: white;
        padding: 10px 15px;
        border-top: 1px solid #d1d5db;
      }

      .chat-input input {
        border-radius: 25px;
        border: 1px solid #d1d5db;
        padding: 10px 15px;
      }

      .chat-input button {
        border-radius: 50%;
        margin-left: 10px;
        padding: 12px 15px;
        background: #2563eb;
        border: none;
        color: white;
        transition: 0.3s;
      }

      .chat-input button:hover {
        background: #1e40af;
      }

      /* Scrollbars */
      .contacts::-webkit-scrollbar,
      .chatbox::-webkit-scrollbar {
        width: 6px;
      }
      .contacts::-webkit-scrollbar-thumb,
      .chatbox::-webkit-scrollbar-thumb {
        background: #9ca3af;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-3 sidebar p-3 chats">
          <a href="{% url 'posts' %}" style="text-decoration: none; color: #2563eb; font-weight: 600;">Go to Posts</a>

          <h5 class="mb-3">Chats</h5>
          <div class="contacts">
            {% for item in user_last_messages %}
            <a
              href="{% url 'chat' item.user.username %}"
              class="list-group-item list-group-item-action {% if item.user.username == room_name %} active {% endif %}"
              data-id="{{ room_name }}"
            >
              <div class="d-flex align-items-center">
                <img
                  src="https://ui-avatars.com/api/?name={{ item.user.username|urlencode }}&size=64&background=random"
                  alt="{{ item.user.username }}'s Profile Image"
                  class="profile-icon rounded-circle mr-3"
                  style="width: 40px; height: 40px"
                />
                <div class="w-100">
                  <div class="d-flex justify-content-between">
                    <strong>{{ item.user.username }}</strong>
                    {% if item.last_message %}
                    <small>{{ item.last_message.timestamp|date:"H:i" }}</small>
                    {% endif %}
                  </div>
                  <small id="last-message">
                    {% if item.last_message %}
                      {% if item.last_message.sender == request.user %}You: {% endif %}
                      {{ item.last_message.content|truncatewords:5 }}
                    {% else %}
                      No messages yet
                    {% endif %}
                  </small>
                </div>
              </div>
            </a>
            {% endfor %}
            
          </div>
          <div class="logout">
            <i class="fas fa-user"></i> {{ request.user.username|title }} <br />
            <a href="{% url 'logout' %}">
              <i class="fas fa-sign-out-alt"></i> Logout
            </a>
          </div>
        </div>

        <!-- Chat Area -->
         
       {% if show_welcome %}
  <!-- Special layout for 'index' room -->
  <div class="col-9 chat" data-id="{{ room_name }}" style="background: #fef3c7; display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <h2 style="color: #b45309; font-weight: bold; margin-bottom: 20px;">Welcome to the Chat!</h2>
    <p style="color: #92400e; font-size: 18px; text-align: center; max-width: 400px;">
      This is your main hub. Start a conversation by selecting a user from the sidebar.
    </p>
    <img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" alt="Welcome Icon" style="width: 150px; margin-top: 20px;">
  </div>
{% else %}
  <!-- Regular chat layout -->
  <div class="col-9 chat" data-id="{{ room_name }}">
    <div class="chat-header">
      <img
        src="https://ui-avatars.com/api/?name={{ room_name|urlencode }}&size=64&background=random"
        class="rounded-circle"
        style="width: 45px; height: 45px; margin-right: 10px"
      />
      <h3>{{ room_name }}</h3>
      <form method="GET" action="" class="p-3 ml-auto">
        <div class="form-group mb-0">
          <input
            type="text"
            name="search"
            id="searchInput"
            class="form-control"
            placeholder="Search messages..."
            value="{{ search_query }}"
          />
        </div>
      </form>
    </div>

    <div id="chatbox" class="chatbox">
      {% if chats %}
        {% for message in chats %}
          <div class="chat-message {% if message.sender == request.user %} sender {% else %} receiver {% endif %}">
            <span>{{ message.content }}</span>
          </div>
        {% endfor %}
      {% else %}
        <p class="no-messages">No Messages.</p>
      {% endif %}
    </div>

    <div class="chat-input d-flex align-items-center">
      <input
        type="text"
        id="my_input"
        class="form-control"
        placeholder="Type a message..."
        required
      />
      <button id="submit_button">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
{% endif %}

      </div>
    </div>

    {{ slug|json_script:"room_slug" }}

    <script>
      const chatbox = document.querySelector("#chatbox");

      function scrollToBottom() {
        chatbox.scrollTop = chatbox.scrollHeight;
      }
      scrollToBottom();

      const roomName = JSON.parse(
        document.getElementById("room_slug").textContent
      );

      const chatSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/chat/{{ room_name }}/"
      );

      chatSocket.onopen = function () {
        console.log("Connected to WebSocket");
      };
      chatSocket.onclose = function () {
        console.log("WebSocket closed unexpectedly");
      };

      document.querySelector("#my_input").focus();
      document.querySelector("#my_input").onkeyup = function (e) {
        if (e.keyCode === 13) {
          e.preventDefault();
          document.querySelector("#submit_button").click();
        }
      };

      document.querySelector("#submit_button").onclick = function () {
        const messageInput = document.querySelector("#my_input").value;

        if (messageInput.length > 0) {
          chatSocket.send(
            JSON.stringify({
              message: messageInput,
              sender: "{{ request.user.username }}",
              room_name: "{{ room_name }}",
            })
          );
          document.querySelector("#my_input").value = "";
        }
      };

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.message && data.sender) {
          const noMessages = document.querySelector(".no-messages");
          if (noMessages) noMessages.style.display = "none";

          const div = document.createElement("div");
          div.className =
            "chat-message " +
            (data.sender === "{{ request.user.username }}"
              ? "sender"
              : "receiver");
          div.innerHTML = `<span>${data.message}</span>`;
          chatbox.appendChild(div);

          scrollToBottom();

          const lastMessage = document.querySelector(
            ".list-group-item.active #last-message"
          );
          if (lastMessage) {
            lastMessage.innerHTML =
              data.sender === "{{ request.user.username }}"
                ? "You: " + data.message
                : data.message;
          }
        }
      };
    </script>
  </body>
</html>
